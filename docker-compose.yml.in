version: "3.8"

networks:
  net:
    external:
      name: "%%COMPOSE_PROJECT_NAME%%_net"

services:

 satalertas_server:
  image: %%TERRAMA2_DOCKER_REGISTRY%%/%%COMPOSE_PROJECT_NAME%%-satalertas-server:%%VERSION%%
  restart: "always"
  deploy:
    mode: global
    restart_policy:
      delay: 10s
      max_attempts: 2
      condition: on-failure
  environment:
      - NODE_ENV=production
  volumes:
      - ./server/config.json:/app/config/config.json
      - ./server/geoserver-conf/config.json:/app/geoserver-conf/config.json
      - "satalertas_documents_vol:/app/documentos"
      - "satalertas_vol:/data"
  ports:
      - "0.0.0.0:%%SERVER_PORT%%:3200"
  networks:
      - net

 satalertas_client:
  image: %%TERRAMA2_DOCKER_REGISTRY%%/%%COMPOSE_PROJECT_NAME%%-satalertas-client:%%VERSION%%
  restart: "always"
  deploy:
    mode: global
    restart_policy:
      delay: 10s
      max_attempts: 2
      condition: on-failure
  environment:
      - PRODUCTION=true
      - PROJECT_ID=%%PROJECT_ID%%
      - BASE_PATH=%%BASE_PATH%%
      - SERVER_URL=%%BASE_URL%%%%BASE_PATH%%alertaServer
      - TERRAMA_URL=%%BASE_URL%%%%BASE_PATH%%adm
      - GEOSERVER_URL=%%BASE_URL%%%%BASE_PATH%%geoserver
  command: sh -c "/usr/share/nginx/html%%BASE_PATH%%alerta/set-env.sh && nginx -g \"daemon off;\""
  volumes:
      - "satalertas_vol:/data"
  ports:
      - "0.0.0.0:%%CLIENT_PORT%%:80"
  networks:
      - net

 quickchart:
    image: ianw/quickchart
    restart: "always"
    deploy:
        mode: global
        restart_policy:
            delay: 10s
            max_attempts: 2
            condition: on-failure
    ports:
      - "0.0.0.0:%%QUICKCHART_PORT%%:3400"
    networks:
      - net

volumes:
  satalertas_documents_vol:
  satalertas_vol:
